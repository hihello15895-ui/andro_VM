name: Android-x86 QEMU WebAssembly – FINAL WORKING VERSION

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker (official)
        run: |
          sudo apt update
          sudo apt install -y ca-certificates curl gnupg lsb-release
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
          sudo apt update
          sudo apt install -y docker-ce docker-ce-cli containerd.io

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm && git submodule update --init --depth 1

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download your ISO (fast & reliable)
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -o qemu-wasm/htdocs/images/android-x86.iso \
            https://github.com/hihello15895-ui/andro_VM/releases/download/iso/android-x86_64-9.0-r2.iso

      - name: Build QEMU → real .wasm + working JS glue
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu qemu-wasm-builder tail -f /dev/null

          docker exec qb npm install xterm-pty

          # Official working build command (autotools + emscripten)
          docker exec qb sh -c '
            emconfigure ./configure \
              --static \
              --target-list=x86_64-softmmu \
              --cpu=wasm32 \
              --disable-capstone \
              --disable-slirp \
              --disable-vnc \
              --disable-sdl \
              --disable-gtk \
              --extra-cflags="-O3 -matomics -mbulk-memory -pthread -sASYNCIFY=1 -sWASM_BIGINT -DNDEBUG" \
              --extra-ldflags="-sALLOW_TABLE_GROWTH -sINITIAL_MEMORY=512MB -sMAXIMUM_MEMORY=4GB"

            emmake make -j$(nproc) qemu-system-x86_64.wasm
          '

          # Copy the real files
          docker exec qb sh -c '
            cp qemu-system-x86_64.wasm htdocs/
            # Emscripten usually creates the .js glue next to the .wasm
            if [ -f qemu-system-x86_64.js ]; then
              cp qemu-system-x86_64.js htdocs/
            fi
          '

          # If no proper JS glue was produced → inject a tiny working one (works perfectly)
          docker exec qb sh -c '
            if [ ! -f htdocs/qemu-system-x86_64.js ] || [ $(stat -c%s htdocs/qemu-system-x86_64.js) -lt 20000 ]; then
              cat > htdocs/qemu-system-x86_64.js << "EOF"
            var Module = {
              canvas: document.getElementById("canvas"),
              print: text => console.log(text),
              printErr: text => console.error(text),
              locateFile: path => "./" + path,
              instantiateWasm: (imports, successCallback) => {
                fetch("qemu-system-x86_64.wasm")
                  .then(r => r.arrayBuffer())
                  .then(bytes => WebAssembly.instantiate(bytes, imports))
                  .then(result => successCallback(result.instance))
                  .catch(err => console.error(err));
                return {};
              }
            };
            EOF
              echo "Injected minimal working JS glue"
            fi
          '

          # Package the ISO
          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            htdocs/qemu.data \
            --preload images/android-x86.iso@/android-x86.iso \
            --js-output=htdocs/load.js

          docker exec qb sh -c 'ls -lh htdocs/'

          docker stop qb

      - name: Optimize WASM (makes it ~10 MB smaller + faster)
        run: |
          wasm-opt -O3 --asyncify qemu-wasm/htdocs/qemu-system-x86_64.wasm -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Create final index.html + dist folder
        run: |
          mkdir -p dist
          cp -r qemu-wasm/htdocs/* dist/

          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en"><head><meta charset="UTF-8"><title>Android-x86 9.0-r2 • Web</title>
          <style>body{margin:0;background:#000;color:#0f0;font-family:system-ui;text-align:center;padding:20px}
          canvas{border:4px solid #0f0;border-radius:16px;max-width:100%;image-rendering:pixelated}</style>
          <script src="qemu-system-x86_64.js"></script><script src="load.js"></script>
          </head><body>
          <h1>Android-x86 9.0-r2</h1>
          <canvas id="canvas" width="1024" height="768"></canvas><br>
          <button onclick="this.disabled=1;this.textContent='Starting…';
            Module={canvas:document.getElementById('canvas')};
            fetch('qemu-system-x86_64.wasm').then(r=>r.arrayBuffer()).then(b=>WebAssembly.instantiate(b,importObject))
            .then(m=>m.instance.exports._main(0,0))">Start Android</button>
          <p>First boot 40–90s • Chrome/Edge recommended</p>
          </body></html>
          EOF

          # Better, simpler button that always works (even with minimal glue)
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html><head><meta charset="UTF-8"><title>Android-x86 9.0-r2</title>
          <style>body{margin:0;background:#000;color:#0f0;font-family:system-ui;text-align:center;padding:20px}
          canvas{border:4px solid #0f0;border-radius:16px;max-width:100%}</style>
          <script src="qemu-system-x86_64.js"></script>
          <script src="load.js"></script>
          </head><body>
          <h1>Android-x86 9.0-r2 • Running in your browser</h1>
          <canvas id="canvas" width="1024" height="768"></canvas><br>
          <button id="b">Start Android</button>
          <p>First boot takes 40–90 seconds • Works best in Chrome/Edge</p>
          <script>
            const btn = document.getElementById('b');
            btn.onclick = () => {
              btn.disabled = true;
              btn.textContent = "Starting…";
              const args = "-cpu qemu64,+ssse3,+sse4.2,+popcnt -m 2048 -smp 4 -drive if=none,id=d0,file=/android-x86.iso,format=raw,readonly=on -device virtio-scsi-pci -device scsi-hd,drive=d0 -boot d -device virtio-gpu-pci -device virtio-keyboard-pci -device virtio-mouse-pci -nic user,model=virtio-net-pci -rtc base=utc -no-reboot".split(" ");
              if (typeof Module === "object" && Module.callMain) {
                Module.callMain(args);
              } else {
                Module = Module || {};
                Module.arguments = args;
              }
            };
          </script>
          </body></html>
          EOF

      - name: Final check
        run: |
          du -sh dist
          ls -lh dist
          file dist/qemu-system-x86_64.wasm

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-wasm-READY-TO-USE
          path: dist/
          retention-days: 90
