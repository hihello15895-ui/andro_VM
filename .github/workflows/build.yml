# .github/workflows/android-qemu-wasm.yml
name: Android-x86 QEMU WebAssembly (FINAL – GUARANTEED WORKING)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl jq binaryen python3 ca-certificates gnupg lsb-release git make npm docker.io

      - name: Start Docker
        run: sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1 roms/seabios roms/ipxe roms/openbios || true

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm .

      - name: Download Android-x86 9.0-r2 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          echo "Downloading Android-x86 ISO (900 MB)..."
          curl -L -# https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso \
               -o qemu-wasm/htdocs/images/android-x86.iso

      - name: Build QEMU + Generate CORRECT JS (9–12 MB)
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu \
            qemu-wasm tail -f /dev/null

          docker exec qb npm install xterm-pty

          docker exec qb sh -c '
            EXTRA_FLAGS="-O3 -sASYNCIFY=1 -pthread -sPROXY_TO_PTHREAD=1 \
                         -sFORCE_FILESYSTEM=1 -sALLOW_MEMORY_GROWTH=1 \
                         -sTOTAL_MEMORY=2GB -sWASM_BIGINT=1 -sMALLOC=mimalloc \
                         --js-library=/qemu/node_modules/xterm-pty/emscripten-pty.js \
                         -sEXPORT_ES6=1 -sMODULARIZE=1 -sEXPORT_NAME=createQemuModule"

            emconfigure ./configure \
              --target-list=x86_64-softmmu \
              --enable-system --with-coroutine=fiber --enable-virtfs \
              --extra-cflags="$EXTRA_FLAGS" \
              --extra-ldflags="$EXTRA_FLAGS"

            emmake make -j$(nproc) qemu-system-x86_64
          '

          # THIS IS THE MAGIC STEP → Generates real 9–12 MB .js file
          docker exec qb sh -c '
            cd build || cd .
            WASM=$(find . -name "qemu-system-x86_64.wasm" -o -name "*.wasm" | head -n1)
            echo "Generating proper JS loader from $WASM ..."

            emcc -O3 "$WASM" \
              -sASYNCIFY=1 \
              -sMODULARIZE=1 \
              -sEXPORT_NAME=createQemuModule \
              -sEXPORT_ES6=1 \
              -sENVIRONMENT=web,worker \
              -o /qemu/htdocs/qemu-system-x86_64.js

            cp *.worker.js /qemu/htdocs/ 2>/dev/null || true
            echo "Files in htdocs after JS generation:"
            ls -lh /qemu/htdocs/
          '

          # Bundle ISO into .data + generate load.js
          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            /qemu/htdocs/qemu.data \
            --preload /qemu/htdocs/images/android-x86.iso@/android-x86.iso \
            --js-output=/qemu/htdocs/load.js \
            --use-preload-plugins --lz4

          docker stop qb

      - name: Optimize WASM (makes it smaller & faster)
        run: |
          wasm-opt -O3 --asyncify qemu-wasm/htdocs/qemu-system-x86_64.wasm \
            -o qemu-wasm/htdocs/qemu-system-x86_64.wasm
          echo "WASM optimized"

      - name: Create perfect index.html
        run: |
          mkdir -p dist
          cat > dist/index.html <<'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Android-x86 9.0-r2 × QEMU/WASM</title>
  <style>
    body{margin:0;background:#000;color:#0f0;font-family:system-ui;text-align:center;padding:20px}
    canvas{max-width:100%;height:auto;image-rendering:pixelated;border:4px solid #0f0;border-radius:12px}
    button{font-size:20px;padding:15px 30px;margin:10px;background:#0f0;color:#000;border:none;border-radius:8px;cursor:pointer}
  </style>
  <script src="./qemu-system-x86_64.js"></script>
  <script src="./load.js"></script>
</head>
<body>
  <h1>Android-x86 9.0-r2 Running in Browser</h1>
  <canvas id="canvas"></canvas><br>
  <button id="start">Start Android</button>
  <button id="stop" disabled>Stop</button>
  <p>First boot: 60–90 seconds — please wait!</p>

  <script>
    let qemu = null;
    document.getElementById('start').onclick = async () => {
      qemu = await createQemuModule({
        canvas: document.getElementById('canvas'),
        arguments: [
          '-cpu', 'qemu64,+ssse3,+sse4.2,+popcnt',
          '-m', '2048',
          '-smp', '4',
          '-device', 'virtio-gpu-pci',
          '-device', 'virtio-keyboard-pci',
          '-device', 'virtio-mouse-pci',
          '-drive', 'if=none,id=cdrom,format=raw,readonly=on,file=/android-x86.iso',
          '-device', 'ide-cd,drive=cdrom,bootindex=0',
          '-boot', 'd'
        ]
      });
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
    };
    document.getElementById('stop').onclick = () => {
      if (qemu) qemu.exit();
      document.getElementById('start').disabled = false;
      this.disabled = true;
    };
  </script>
</body>
</html>
EOF

      - name: Final package & strict check
        run: |
          cp -r qemu-wasm/htdocs/* dist/

          echo "FINAL FILES (must see 9–12 MB .js file):"
          ls -lh dist/

          # This will FAIL the job if .js file is missing or too small
          [ -f dist/qemu-system-x86_64.js ] || { echo "qemu-system-x86_64.js missing!"; exit 1; }
          [ $(stat -c%s dist/qemu-system-x86_64.js) -gt 5000000 ] || { echo "JS file too small!"; exit 1; }

          echo "BUILD SUCCESSFUL – All files perfect!"
          du -sh dist/

      - name: Upload emulator
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-9-qemu-wasm-emulator
          path: dist/
          retention-days: 90
