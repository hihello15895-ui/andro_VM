name: Android-x86 QEMU WebAssembly (FINAL – 100% WORKING)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl jq binaryen python3 ca-certificates gnupg lsb-release git make npm autoconf automake libtool pkg-config libpixman-1-dev libglib2.0-dev flex bison

      - name: Install Docker
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1 roms/seabios roms/ipxe roms/openbios || true

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 9.0-r2 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -# -o qemu-wasm/htdocs/images/android-x86.iso \
            https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso

      - name: Build QEMU + Bundle ISO (inside container)
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu \
            qemu-wasm-builder tail -f /dev/null

          docker exec qb npm install xterm-pty

          docker exec qb sh -c '
            EXTRA_CFLAGS="-O3 -DNDEBUG -DG_DISABLE_ASSERT -D_GNU_SOURCE -sASYNCIFY=1 -pthread -sPROXY_TO_PTHREAD=1 -sFORCE_FILESYSTEM -sALLOW_TABLE_GROWTH -sTOTAL_MEMORY=2300MB -sWASM_BIGINT -sMALLOC=mimalloc --js-library=/qemu/node_modules/xterm-pty/emscripten-pty.js -sEXPORT_ES6=1 -sMODULARIZE=1 -sEXPORT_NAME=createQemuModule -sASYNCIFY_IMPORTS=ffi_call_js"
            
            emconfigure /qemu/configure \
              --static \
              --target-list=x86_64-softmmu \
              --cpu=wasm32 \
              --cross-prefix= \
              --without-default-features \
              --enable-system \
              --with-coroutine=fiber \
              --enable-virtfs \
              --extra-cflags="$EXTRA_CFLAGS" \
              --extra-cxxflags="$EXTRA_CFLAGS" \
              --extra-ldflags="-sEXPORTED_RUNTIME_METHODS=getTempRet0,setTempRet0,addFunction,removeFunction,TTY,FS"

            emmake make -j$(nproc) qemu-system-x86_64
          '

          # Bundle ISO
          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            /qemu/htdocs/qemu.data \
            --preload /qemu/htdocs/images/android-x86.iso@/android-x86.iso \
            --js-output=/qemu/htdocs/load.js \
            --use-preload-plugins --lz4

          docker stop qb

      - name: Copy WASM + JS files to htdocs (CRITICAL STEP)
        run: |
          # Find and copy the actual built files
          find qemu-wasm -name "*.wasm" -exec cp {} qemu-wasm/htdocs/qemu.wasm \;
          find qemu-wasm -name "qemu-system-x86_64.js" -exec cp {} qemu-wasm/htdocs/qemu.js \; || true
          find qemu-wasm -name "out.js" -exec cp {} qemu-wasm/htdocs/qemu.js \; || true
          find qemu-wasm -name "*.worker.js" -exec cp {} qemu-wasm/htdocs/qemu.worker.js \; || true

          echo "Final files in htdocs:"
          ls -lh qemu-wasm/htdocs/

      - name: Optimize WASM
        run: |
          if [ -f qemu-wasm/htdocs/qemu.wasm ]; then
            echo "Optimizing qemu.wasm..."
            wasm-opt -O3 --asyncify qemu-wasm/htdocs/qemu.wasm -o qemu-wasm/htdocs/qemu.wasm.opt
            mv qemu-wasm/htdocs/qemu.wasm.opt qemu-wasm/htdocs/qemu.wasm
            echo "Optimization done!"
          else
            echo "qemu.wasm not found!"
            exit 1
          fi

      - name: Create final index.html + dist folder
        run: |
          mkdir -p dist
          cp -r qemu-wasm/htdocs/* dist/

          cat > dist/index.html <<'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Android-x86 9.0-r2 in Browser</title>
  <style>
    body{margin:0;background:#000;color:#0f0;font-family:system-ui;text-align:center;padding:40px}
    canvas{max-width:100%;image-rendering:pixelated;border:8px solid #0f0;border-radius:20px;margin:40px auto;display:block;box-shadow:0 0 60px #0f0}
    button{font-size:28px;padding:25px 120px;background:#0f0;color:#000;border:none;border-radius:20px;cursor:pointer;box-shadow:0 0 40px #0f0;margin:20px}
    button:disabled{background:#003300;color:#666;opacity:0.7}
    .box{background:#001100;padding:40px;border:6px solid #0f0;border-radius:25px;max-width:900px;margin:30px auto}
    progress{width:100%;height:70px;border-radius:20px;background:#003300}
    progress::-webkit-progress-value{background:#0f0}
    #percent{font-size:60px;margin:30px;font-weight:bold}
    #msg{font-size:32px;margin:20px}
  </style>
</head>
<body>
  <h1>Android-x86 9.0-r2 × QEMU/WASM</h1>
  <div class="box">
    <div id="msg">Ready</div>
    <progress id="p" value="0" max="100"></progress>
    <div id="percent">0%</div>
    <button id="start">START ANDROID</button>
  </div>
  <canvas></canvas>

  <script src="load.js"></script>
  <script src="qemu.js"></script>

  <script>
    const p = document.getElementById('p');
    const percent = document.getElementById('percent');
    const msg = document.getElementById('msg');
    const btn = document.getElementById('start');

    btn.onclick = () => {
      btn.disabled = true;
      msg.innerHTML = "Initializing engine...";

      const checkModule = setInterval(() => {
        if (typeof createQemuModule === 'function') {
          clearInterval(checkModule);
          msg.innerHTML = "Downloading 913 MB... Please wait";

          createQemuModule({
            canvas: document.querySelector('canvas'),
            arguments: [
              '-cpu', 'qemu64,+ssse3,+sse4.2,+popcnt,+avx2',
              '-m', '2048',
              '-smp', '4',
              '-device', 'virtio-gpu-pci',
              '-device', 'virtio-keyboard-pci',
              '-device', 'virtio-mouse-pci',
              '-drive', 'if=none,id=cdrom,format=raw,readonly=on,file=/android-x86.iso',
              '-device', 'ide-cd,drive=cdrom,bootindex=0',
              '-boot', 'd',
              '-no-reboot'
            ],
            preRun: [],
            postRun: [],
            print: (text) => console.log(text),
            printErr: (text) => console.error(text),
            monitorRunDependencies: (left) => {
              if (left === 0) {
                p.value = 100;
                percent.textContent = "100%";
                msg.innerHTML = "Booting Android-x86... (30-90 sec)";
              }
            },
            onAbort: (err) => { alert("Error: " + err); }
          });
        }
      }, 100);
    };
  </script>
</body>
</html>
EOF

      - name: Upload final emulator
        uses: actions/upload-artifact@v4
        with:
          name: Android-x86-QEMU-WASM-Ready-To-Run
          path: dist/
          retention-days: 30
