name: Android-x86 WebAssembly Emulator (v86)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:
    inputs:
      download_iso:
        description: 'Download real Android-x86 ISO (true/false)'
        required: false
        default: 'false'
      use_test_iso:
        description: 'On download failure, create tiny dummy ISO (true/false)'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOWNLOAD_ISO: ${{ inputs.download_iso || 'false' }}
      USE_TEST_ISO: ${{ inputs.use_test_iso || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.58

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git make binaryen wget curl ca-certificates clang build-essential python3

      - name: Clone v86
        run: |
          git clone --depth 1 https://github.com/copy/v86.git
          cd v86 && git submodule update --init --recursive

      - name: Download Android-x86 ISO (robust)
        run: |
          set -euo pipefail
          mkdir -p v86/images
          cd v86/images

          ISO_URL="https://osdn.net/dl/android-x86/android-x86_64-4.4-r5.iso"
          UA="Mozilla/5.0 (compatible; GitHub-Actions)"

          if [ "$DOWNLOAD_ISO" = "false" ]; then
            if ls ../../*android*.iso >/dev/null 2>&1 || [ -f android-x86.iso ]; then
              echo "Using existing ISO from repository"
              cp ../../*android*.iso android-x86.iso 2>/dev/null || true
              exit 0
            else
              echo "No local ISO and download disabled → skipping ISO"
              exit 0
            fi
          fi

          echo "Downloading Android-x86 ISO (~300 MB)..."
          if ! wget --user-agent="$UA" --tries=10 --timeout=60 -c -O android-x86.iso "$ISO_URL"; then
            echo "wget failed → trying curl..."
            curl -f -L --retry 10 --retry-delay 5 -A "$UA" -o android-x86.iso "$ISO_URL"
          fi

          # Fallback to tiny dummy ISO if still missing
          if [ ! -f android-x86.iso ] || [ $(stat -c%s android-x86.iso 2>/dev/null || echo 0) -lt 5000000 ]; then
            if [ "$USE_TEST_ISO" = "true" ]; then
              echo "Creating 10 MB dummy ISO..."
              dd if=/dev/zero of=android-x86.iso bs=1M count=10
            else
              echo "ISO download failed and no fallback allowed"
              exit 1
            fi
          fi

          echo "ISO ready: $(du -h android-x86.iso)"

      - name: Build v86 (with fallbacks)
        run: |
          set -euo pipefail
          cd v86

          TARGETS=(
            "build/libv86.js"
            "build/v86_all.js"
            "build/v86.wasm"
            "build/libv86.mjs"
            "libv86.js"
            "all"
          )

          for t in "${TARGETS[@]}"; do
            echo "Trying: emmake make $t"
            if emmake make -j$(nproc) "$t"; then
              echo "Success with target: $t"
              break
            fi
          done

          # Final fallbacks
          emmake make -j$(nproc) || npm run build || true

          if ! compgen -G "{build/,}*.js" "{build/,}*.wasm" > /dev/null; then
            echo "No JS/WASM files produced!"
            exit 1
          fi

          echo "Build successful. Artifacts:"
          ls -la {build/,}*.js {build/,}*.wasm 2>/dev/null || true

      - name: Package all files
        run: |
          mkdir -p dist
          cp v86/{build/,}*.js v86/{build/,}*.mjs v86/{build/,}*.wasm dist/ 2>/dev/null || true
          cp v86/images/android-x86.iso dist/ 2>/dev/null || true

          # Optimize WASM (safe in GitHub Actions)
          for f in dist/*.wasm; do
            [ -f "$f" ] && wasm-opt -O3 --strip-debug "$f" -o "$f.opt" && mv "$f.opt" "$f" || true
          done

          echo "Final dist contents:"
          ls -la dist

      - name: Upload raw emulator files
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-v86-raw-files
          path: dist/*
          retention-days: 90
