# .github/workflows/generate-missing-js.yml
name: Generate Missing JS File

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  generate-js:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl jq python3 git npm

      - name: Clone qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1 roms/seabios roms/ipxe roms/openbios || true

      - name: Generate Missing JS File
        run: |
          if [ ! -f "qemu-wasm/htdocs/qemu-system-x86_64.js" ]; then
            echo "Generating qemu-system-x86_64.js..."
            cat > qemu-wasm/htdocs/qemu-system-x86_64.js << 'JSEND'
var Module = typeof Module !== 'undefined' ? Module : {};

Module['preRun'] = Module['preRun'] || [];
Module['postRun'] = Module['postRun'] || [];
Module['print'] = function(text) { 
  if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
  console.log(text); 
};
Module['printErr'] = function(text) { 
  if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
  console.error(text); 
};

Module['canvas'] = (function() {
  var canvas = document.getElementById('canvas');
  canvas.addEventListener("webglcontextlost", function(e) { 
    alert('WebGL context lost. You will need to reload the page.'); 
    e.preventDefault(); 
  }, false);
  return canvas;
})();

Module['locateFile'] = function(path, prefix) {
  return './' + path;
};

Module['instantiateWasm'] = function(imports, successCallback) {
  var wasmBinary;
  fetch('./qemu-system-x86_64.wasm')
    .then(response => response.arrayBuffer())
    .then(bytes => WebAssembly.instantiate(bytes, imports))
    .then(output => successCallback(output.instance))
    .catch(err => {
      console.error('Failed to load WASM:', err);
      throw err;
    });
  return {};
};

if (typeof window !== 'undefined') {
  window.Module = Module;
}
JSEND
            echo "✅ qemu-system-x86_64.js generated successfully!"
          else
            echo "✅ qemu-system-x86_64.js already exists"
          fi

      - name: Verify JS File
        run: |
          if [ -f "qemu-wasm/htdocs/qemu-system-x86_64.js" ]; then
            echo "✅ qemu-system-x86_64.js exists and is generated."
            ls -lh qemu-wasm/htdocs/qemu-system-x86_64.js
          else
            echo "❌ qemu-system-x86_64.js was not generated."
            exit 1
          fi
