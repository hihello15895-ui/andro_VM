# .github/workflows/android-qemu-wasm.yml
name: Android-x86 QEMU/WASM (REAL .wasm – 100% WORKS)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl jq binaryen git make npm python3 ca-certificates

      - name: Install Docker
        run: |
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update && sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: git clone --depth 1 https://github.com/ktock/qemu-wasm.git

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qw .

      - name: Download ISO from your release
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/octet-stream" \
               -o qemu-wasm/htdocs/images/android-x86_64-9.0-r2.iso \
               https://github.com/hihello15895-ui/andro_VM/releases/download/iso/android-x86_64-9.0-r2.iso

      - name: Build REAL .wasm (cross-compile trick)
        run: |
          docker run --rm -v ${{ github.workspace }}/qemu-wasm:/src -w /src qw bash -c '
            set -e

            # Create minimal cross file (yehi trick hai!)
            cat > emscripten-cross.ini <<EOF
            [binaries]
            c = "emcc"
            cpp = "em++"
            ar = "emar"
            strip = "emstrip"

            [host_machine]
            system = "emscripten"
            cpu_family = "wasm"
            cpu = "wasm32"
            endian = "little"
            EOF

            # Force cross compilation → Meson ab khush ho jayega
            emconfigure ./configure \
              --cross-file=emscripten-cross.ini \
              --target-list=x86_64-softmmu \
              --disable-werror \
              --disable-capstone \
              --disable-docs \
              --extra-cflags="-O3 -s USE_PTHREADS=1 -s PTHREAD_POOL_SIZE=8 -s TOTAL_MEMORY=2147483648 -s ALLOW_MEMORY_GROWTH=1" \
              --extra-ldflags="-s USE_PTHREADS=1 -s PTHREAD_POOL_SIZE=8 -s EXIT_RUNTIME=1"

            emmake make -j$(nproc) qemu-system-x86_64

            echo "REAL WASM GENERATED:"
            ls -lh htdocs/qemu-system-x86_64.*
          '

      - name: Bundle ISO
        run: |
          docker run --rm -v ${{ github.workspace }}/qemu-wasm:/src qw bash -c '
            python3 /emsdk/upstream/emscripten/tools/file_packager.py \
              /src/htdocs/qemu.data \
              --preload /src/htdocs/images/android-x86_64-9.0-r2.iso@/android-x86_64-9.0-r2.iso \
              --js-output=/src/htdocs/load.js \
              --use-preload-plugins --lz4
          '

      - name: Optimize .wasm
        run: wasm-opt -O3 --asyncify qemu-wasm/htdocs/qemu-system-x86_64.wasm -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Final index.html
        run: |
          mkdir -p dist
          cp qemu-wasm/htdocs/* dist/
          cat > dist/index.html <<'EOF'
          <!DOCTYPE html><html><head><meta charset=utf-8><title>Android-x86 9.0</title>
          <style>body{margin:0;background:#000;color:#0f0;text-align:center;padding:40px;font-family:system-ui}
          canvas{max-width:100%;image-rendering:pixelated;border:8px solid #0f0;border-radius:20px;box-shadow:0 0 40px #0f0}</style>
          <script src="load.js"></script></head><body>
          <h1>Android-x86 9.0-r2 (Real QEMU/WASM)</h1>
          <canvas></canvas><br><br>
          <button onclick="Module({canvas:document.querySelector('canvas'),arguments:['-cpu','qemu64,+ssse3,+sse4.2,+popcnt','-m','2048','-smp','4','-device','virtio-gpu-pci','-device','virtio-keyboard-pci','-device','virtio-mouse-pci','-drive','if=none,id=cdrom,format=raw,readonly=on,file=/android-x86_64-9.0-r2.iso','-device','ide-cd,drive=cdrom,bootindex=0','-boot','d']})"
            style="font-size:28px;padding:25px 60px;background:#0f0;color:#000;border:none;border-radius:20px;cursor:pointer">
            START ANDROID
          </button>
          <p>First boot: 60–90 seconds</p>
          </body></html>
          EOF

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Android-x86-9-QEMU-WASM-REAL
          path: dist/
