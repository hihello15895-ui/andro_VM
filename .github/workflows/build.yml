name: Build Android-x86 WebAssembly Emulator with v86

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
    paths:
      - '.github/workflows/build-android-wasm.yml'
      - 'android/**'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - '.github/workflows/build-android-wasm.yml'
      - 'android/**'
  workflow_dispatch:

env:
  EM_VERSION: 3.1.58
  EM_CACHE_FOLDER: 'android-emsdk-cache'
  V86_VERSION: 'main'

jobs:
  build-android-wasm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Emscripten cache
        uses: actions/cache@v4
        with:
          path: ${{ env.EM_CACHE_FOLDER }}
          key: v86-${{ env.EM_VERSION }}-${{ runner.os }}

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build git make gcc g++ wget unzip binaryen build-essential

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ env.EM_VERSION }}
          actions-cache-folder: ${{ env.EM_CACHE_FOLDER }}

      - name: Clone v86
        run: |
          git clone --depth 1 https://github.com/copy/v86.git
          cd v86
          git submodule update --init --recursive

      - name: Download Android-x86 ISO
        run: |
          cd v86/images
          wget -q https://osdn.net/dl/android-x86/android-x86_64-4.4-r5.iso -O android-x86.iso

      - name: Build v86
        run: |
          cd v86
          emmake make -j$(nproc) libv86.js

          # Optimize WASM
          for f in *.wasm; do
            [ -f "$f" ] && wasm-opt -O4 --strip "$f" -o "$f.opt" && mv "$f.opt" "$f"
          done

      - name: Prepare output
        run: |
          mkdir -p android-output/x86
          cp v86/libv86.js android-output/x86/
          cp v86/*.wasm android-output/x86/ 2>/dev/null || true
          cp v86/images/android-x86.iso android-output/x86/

      - name: Create wrapper
        run: |
          cat > android-output/x86/android-v86-wrapper.js << 'EOF'
class AndroidV86Emulator {
  constructor() {
    this.emulator = null;
    this.isRunning = false;
  }
  async initialize() {
    const mod = await import("./libv86.js");
    this.emulator = new mod.V86({
      wasm_url: "./v86.wasm",
      memory_size: 512 * 1024 * 1024,
      vga_memory_size: 8 * 1024 * 1024,
      screen_container: document.getElementById("v86-canvas")?.parentNode,
      autostart: false
    });
    await new Promise(r => this.emulator.add_listener("emulator-ready", r));
  }
  async start() {
    if (!this.emulator) await this.initialize();
    this.emulator.boot_from_cdrom();
    this.emulator.run();
    this.isRunning = true;
  }
  stop() {
    if (this.emulator) this.emulator.stop();
    this.isRunning = false;
  }
}
if (typeof module !== "undefined" && module.exports) module.exports = AndroidV86Emulator;
else if (typeof window !== "undefined") window.AndroidV86Emulator = AndroidV86Emulator;
EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-v86-wasm
          path: android-output/x86/

  android-demo:
    needs: build-android-wasm
    runs-on: ubuntu-latest

    steps:
      - name: Download built files
        uses: actions/download-artifact@v4
        with:
          name: android-v86-wasm
          path: demo

      - name: Create demo HTML
        run: |
          cat > demo/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Android-x86 in Browser (v86 + WASM)</title>
  <style>
    body { margin:0; background:#222; font-family:sans-serif; color:white; text-align:center; padding:20px; }
    #phone { width:400px; height:800px; margin:20px auto; border:20px solid #000; border-radius:40px; overflow:hidden; background:#000; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
    canvas { width:100%; height:100%; display:block; }
    button { margin:10px; padding:12px 24px; font-size:16px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Android-x86 WebAssembly Emulator</h1>
  <div id="phone"><div><canvas id="v86-canvas"></canvas></div></div>
  <button id="start">Start Android</button>
  <button id="stop" disabled>Stop</button>
  <p>Boot takes ~1â€“2 minutes. Be patient!</p>

  <script type="module">
    import AndroidV86Emulator from "./android-v86-wrapper.js";
    const emu = new AndroidV86Emulator();

    document.getElementById("start").onclick = async () => {
      document.getElementById("start").disabled = true;
      await emu.start();
      document.getElementById("stop").disabled = false;
    };
    document.getElementById("stop").onclick = () => {
      emu.stop();
      document.getElementById("start").disabled = false;
      document.getElementById("stop").disabled = true;
    };
  </script>
</body>
</html>
EOF

      - name: Upload demo
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-demo
          path: demo/
