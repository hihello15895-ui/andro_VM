name: Android-x86 QEMU WebAssembly (FIXED — JS Loader Included)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl jq binaryen python3 git make npm

      - name: Install Docker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y docker.io
          sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1 roms/seabios roms/ipxe roms/openbios || true

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 9.0-r2 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -# -o qemu-wasm/htdocs/images/android-x86.iso \
            https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso

      - name: Build QEMU inside container
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu \
            qemu-wasm-builder tail -f /dev/null

          docker exec qb npm install xterm-pty

          docker exec qb bash -c '
            EXTRA_CFLAGS="-O3 -g -Wno-error=unused-command-line-argument -matomics -mbulk-memory \
            -DNDEBUG -DG_DISABLE_ASSERT -D_GNU_SOURCE -sASYNCIFY=1 -pthread -sPROXY_TO_PTHREAD=1 \
            -sFORCE_FILESYSTEM -sALLOW_TABLE_GROWTH -sTOTAL_MEMORY=2300MB -sWASM_BIGINT \
            -sMALLOC=mimalloc --js-library=/qemu/node_modules/xterm-pty/emscripten-pty.js \
            -sEXPORT_ES6=1 -sASYNCIFY_IMPORTS=ffi_call_js"

            emconfigure /qemu/configure \
              --static --target-list=x86_64-softmmu --cpu=wasm32 \
              --without-default-features --enable-system --with-coroutine=fiber --enable-virtfs \
              --extra-cflags="$EXTRA_CFLAGS" --extra-cxxflags="$EXTRA_CFLAGS"

            emmake make -j$(nproc) qemu-system-x86_64
          '

      - name: Copy WASM + JS Loader (IMPORTANT FIX)
        run: |
          docker exec qb bash -c '
            cd /qemu/build || cd /qemu

            WASM_FILE=$(find . -name "qemu-system-x86_64.wasm" -type f | head -n1)
            JS_FILE=$(find . -name "qemu-system-x86_64.js" -type f | head -n1)

            echo "Found WASM: $WASM_FILE"
            echo "Found JS: $JS_FILE"

            cp "$WASM_FILE" /qemu/htdocs/qemu-system-x86_64.wasm
            cp "$JS_FILE"  /qemu/htdocs/qemu-system-x86_64.js
          '

          docker stop qb

      - name: Build preload ISO data file
        run: |
          python3 qemu-wasm/emsdk/upstream/emscripten/tools/file_packager.py \
            qemu-wasm/htdocs/qemu.data \
            --preload qemu-wasm/htdocs/images/android-x86.iso@/android-x86.iso \
            --js-output=qemu-wasm/htdocs/load.js \
            --use-preload-plugins --lz4

      - name: Optimize WASM
        run: |
          wasm-opt -O3 --asyncify \
            qemu-wasm/htdocs/qemu-system-x86_64.wasm \
            -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Create final index.html
        run: |
          mkdir -p dist
          cat > dist/index.html <<'EOF'
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Android-x86 9.0 × QEMU/WASM</title>
<style>
  body{margin:0;background:#000;color:#0f0;text-align:center;padding:20px}
  canvas{max-width:100%;border:4px solid #0f0;border-radius:12px}
  button{font-size:20px;padding:15px;margin:10px;background:#0f0;color:#000}
</style>
<script src="./qemu-system-x86_64.js"></script>
<script src="./load.js"></script>
</head>
<body>
<h1>Android-x86 9.0-r2 in Browser</h1>
<canvas id="canvas"></canvas><br>
<button id="start">Start Android</button>
<button id="stop" disabled>Stop</button>
<script>
start.onclick = () => {
  Module({
    canvas: document.getElementById("canvas"),
    arguments: [
      "-cpu","qemu64,+ssse3,+sse4.2,+popcnt",
      "-m","2048","-smp","4",
      "-device","virtio-gpu-pci",
      "-device","virtio-keyboard-pci",
      "-device","virtio-mouse-pci",
      "-drive","if=none,id=cdrom,format=raw,readonly=on,file=/android-x86.iso",
      "-device","ide-cd,drive=cdrom,bootindex=0",
      "-boot","d"
    ]
  });
  start.disabled = true;
  stop.disabled = false;
};
stop.onclick = () => {
  Module?.stop?.();
  start.disabled = false;
  stop.disabled = true;
};
</script>
</body>
</html>
EOF

      - name: Package final files
        run: |
          cp -r qemu-wasm/htdocs/* dist/
          ls -lh dist/
          du -sh dist/

      - name: Upload emulator
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-9-qemu-wasm-emulator
          path: dist/
