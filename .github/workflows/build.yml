name: Android-x86 QEMU WebAssembly Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl jq python3 git make npm docker.io binaryen wasm-opt

      - name: Start Docker
        run: sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -o qemu-wasm/htdocs/images/android-x86.iso \
          https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso

      - name: Build QEMU WASM inside Docker
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu qemu-wasm-builder tail -f /dev/null

          docker exec qb npm install xterm-pty

          docker exec qb sh -c '
            EXTRA_CFLAGS="-O3 -g -matomics -mbulk-memory -sASYNCIFY=1 -pthread -sWASM_BIGINT -DNDEBUG"
            emconfigure ./configure \
              --static --target-list=x86_64-softmmu --cpu=wasm32 \
              --extra-cflags="$EXTRA_CFLAGS" \
              --extra-ldflags="-sALLOW_TABLE_GROWTH"
            emmake make -j$(nproc)
          '

          docker exec qb sh -c '
            WASM=$(find /qemu -name "*.wasm" | head -n1)
            cp "$WASM" /qemu/htdocs/qemu-system-x86_64.wasm
          '

          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            /qemu/htdocs/qemu.data \
            --preload /qemu/htdocs/images/android-x86.iso@/android-x86.iso \
            --js-output=/qemu/htdocs/load.js

          docker stop qb

      - name: Generate qemu-system-x86_64.js
        run: |
cat > qemu-wasm/htdocs/qemu-system-x86_64.js << 'EOF'
var Module = typeof Module !== 'undefined' ? Module : {};
Module.print = function(text) { if(arguments.length>1) text=Array.prototype.slice.call(arguments).join(' '); console.log(text); };
Module.printErr = function(text) { if(arguments.length>1) text=Array.prototype.slice.call(arguments).join(' '); console.error(text); };
Module.preRun = Module.preRun || [];
Module.postRun = Module.postRun || [];
Module.canvas = (function(){ let c=document.getElementById('canvas'); c.addEventListener('webglcontextlost', e=>{alert('WebGL context lost. Reload.'); e.preventDefault();}); return c;})();
Module.locateFile = function(path){ return './'+path; };
Module.instantiateWasm = function(imports, successCallback){ fetch('./qemu-system-x86_64.wasm').then(r=>r.arrayBuffer()).then(b=>WebAssembly.instantiate(b, imports)).then(o=>successCallback(o.instance)).catch(err=>{console.error(err); throw err;}); return {}; };
window.Module = Module;
EOF

      - name: Optimize WASM
        run: |
          WASM=$(ls qemu-wasm/htdocs/*.wasm | head -n1)
          wasm-opt -O3 --asyncify "$WASM" -o "$WASM.opt"
          mv "$WASM.opt" "$WASM"

      - name: Create index.html
        run: |
cat > dist/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Android-x86 9.0 QEMU/WASM</title>
<style>
body { background:#000; color:#0f0; text-align:center; font-family:system-ui; }
canvas { border:3px solid #0f0; border-radius:12px; margin-top:20px; }
button { font-size:16px; padding:10px 20px; margin-top:10px; cursor:pointer; }
</style>
<script src="./qemu-system-x86_64.js"></script>
<script src="./load.js"></script>
</head>
<body>
<h1>Android-x86 QEMU WebAssembly</h1>
<canvas id="canvas" width="1024" height="768"></canvas>
<button onclick="startVM()">Start Android</button>
<script>
function startVM() {
  Module({ arguments:['-cpu','qemu64','-m','2048','-smp','4','-drive','file=/android-x86.iso,format=raw,readonly=on','-boot','d'] });
}
</script>
</body>
</html>
EOF

      - name: Copy dist files
        run
