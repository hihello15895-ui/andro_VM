name: Android-x86 QEMU WebAssembly Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf "/usr/local/share/boost" || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl git make npm python3 binaryen docker.io
          sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm && git submodule update --init --depth 1

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -o qemu-wasm/htdocs/images/android-x86.iso \
            https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso

      - name: Build QEMU WebAssembly + proper JS glue
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu qemu-wasm-builder tail -f /dev/null

          docker exec qb npm install xterm-pty

          docker exec qb sh -c '
            EXTRA_CFLAGS="-O3 -DNDEBUG -matomics -mbulk-memory -pthread -sWASM_BIGINT"
            emconfigure ./configure \
              --static \
              --target-list=x86_64-softmmu \
              --cpu=wasm32 \
              --disable-capstone --disable-libssh --disable-gtk --disable-sdl \
              --extra-cflags="$EXTRA_CFLAGS" \
              --extra-ldflags="-sALLOW_TABLE_GROWTH -sASYNCIFY=1"

            emmake make -j$(nproc) qemu-system-x86_64.wasm
          '

          docker exec qb sh -c '
            emcc -O3 qemu-system-x86_64.wasm \
              -s ENVIRONMENT=web \
              -s ASYNCIFY=1 \
              -s WASM_BIGINT=1 \
              -s ALLOW_MEMORY_GROWTH=1 \
              -s INITIAL_MEMORY=512MB \
              -s MAXIMUM_MEMORY=4GB \
              -s EXPORTED_FUNCTIONS=_main \
              -s EXPORTED_RUNTIME_METHODS=FS,callMain,ENV \
              -s MODULARIZE=1 \
              -s EXPORT_NAME="createQemuModule" \
              --shell-file html/shell_minimal.html \
              -o htdocs/qemu-system-x86_64.js
          '

          docker exec qb cp qemu-system-x86_64.wasm htdocs/

          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            htdocs/qemu.data \
            --preload images/android-x86.iso@/android-x86.iso \
            --js-output=htdocs/load.js

          docker stop qb

      - name: Optimize .wasm
        run: |
          wasm-opt -O3 --asyncify \
            qemu-wasm/htdocs/qemu-system-x86_64.wasm \
            -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Create index.html (fixed heredoc syntax)
        run: |
          mkdir -p dist
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Android-x86 9.0-r2 • QEMU/WASM</title>
            <style>
              body {margin:0; padding:20px; background:#000; color:#0f0; font-family:system-ui; text-align:center;}
              canvas {border:4px solid #0f0; border-radius:16px; max-width:100%; image-rendering:pixelated;}
              button {font-size:18px; padding:14px 32px; margin:20px; background:#000; color:#0f0; border:2px solid #0f0; border-radius:12px; cursor:pointer;}
              button:disabled {opacity:0.6; cursor:not-allowed;}
              .info {margin:20px; opacity:0.8; font-size:14px;}
            </style>
            <script src="./qemu-system-x86_64.js"></script>
            <script src="./load.js"></script>
          </head>
          <body>
            <h1>Android-x86 9.0-r2 (Pie)</h1>
            <p>Running in your browser via QEMU + WebAssembly</p>
            <canvas id="canvas" width="1024" height="768"></canvas><br>
            <button id="startBtn">Start Android</button>
            <div class="info">First boot: 30–90 seconds • Best on Chrome/Edge • No install needed</div>

            <script>
            const Module = {
              canvas: document.getElementById('canvas'),
              print: txt => console.log(txt),
              printErr: txt => console.error(txt)
            };

            document.getElementById('startBtn').onclick = function() {
              this.disabled = true;
              this.textContent = "Starting… (30–90s)";
              const args = [
                '-cpu', 'qemu64,+ssse3,+sse4.2,+popcnt',
                '-m', '2048',
                '-smp', '4',
                '-drive', 'if=none,id=d0,file=/android-x86.iso,format=raw,readonly=on',
                '-device', 'virtio-scsi-pci',
                '-device', 'scsi-hd,drive=d0',
                '-boot', 'd',
                '-device', 'virtio-gpu-pci',
                '-device', 'virtio-keyboard-pci',
                '-device', 'virtio-mouse-pci',
                '-nic', 'user,model=virtio-net-pci',
                '-rtc', 'base=utc',
                '-no-reboot'
              ];
              if (typeof createQemuModule !== 'undefined') {
                createQemuModule(Module).then(mod => mod.callMain(args));
              } else {
                Module.arguments = args;
              }
            };
            </script>
          </body>
          </html>
          EOF

      - name: Assemble final dist folder
        run: |
          cp -r qemu-wasm/htdocs/* dist/
          mv dist/index.html dist/index.html  # our version wins

      - name: Verify files
        run: |
          set -e
          ls -lh dist
          [ -f dist/qemu-system-x86_64.wasm ] && echo "wasm OK"
          [ $(stat -c%s dist/qemu-system-x86_64.js) -gt 30000 ] && echo "js OK"
          [ $(stat -c%s dist/qemu.data) -gt 800000000 ] && echo "data OK"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-wasm
          path: dist/
          retention-days: 60
