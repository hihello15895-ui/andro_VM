name: Android-x86 QEMU WebAssembly Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true

      - name: Install dependencies (Docker fixed for Ubuntu 24.04)
        run: |
          sudo apt update
          sudo apt install -y curl git make npm python3 python3-pip binaryen jq ca-certificates gnupg lsb-release

          # Official Docker installation (works 100% on ubuntu-24.04 runners)
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          sudo chmod a+r /etc/apt/keyrings/docker.gpg

          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
            https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

          sudo apt update
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin

          # Test Docker
          sudo docker run --rm hello-world

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm && git submodule update --init --depth 1

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -o qemu-wasm/htdocs/images/android-x86.iso \
            https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso

      - name: Build QEMU + generate correct JS glue
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu qemu-wasm-builder tail -f /dev/null

          docker exec qb npm install xterm-pty

          docker exec qb sh -c '
            EXTRA_CFLAGS="-O3 -DNDEBUG -matomics -mbulk-memory -pthread -sWASM_BIGINT"
            emconfigure ./configure \
              --static --target-list=x86_64-softmmu --cpu=wasm32 \
              --disable-capstone --disable-libssh --disable-gtk --disable-sdl \
              --extra-cflags="$EXTRA_CFLAGS" \
              --extra-ldflags="-sALLOW_TABLE_GROWTH -sASYNCIFY=1"

            emmake make -j$(nproc) qemu-system-x86_64.wasm
          '

          docker exec qb sh -c '
            emcc -O3 qemu-system-x86_64.wasm \
              -s ENVIRONMENT=web -s ASYNCIFY=1 -s WASM_BIGINT=1 \
              -s ALLOW_MEMORY_GROWTH=1 -s INITIAL_MEMORY=512MB -s MAXIMUM_MEMORY=4GB \
              -s EXPORTED_FUNCTIONS=_main \
              -s EXPORTED_RUNTIME_METHODS=FS,callMain,ENV \
              -s MODULARIZE=1 -s EXPORT_NAME="createQemuModule" \
              --shell-file html/shell_minimal.html \
              -o htdocs/qemu-system-x86_64.js
          '

          docker exec qb cp qemu-system-x86_64.wasm htdocs/

          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            htdocs/qemu.data --preload images/android-x86.iso@/android-x86.iso \
            --js-output=htdocs/load.js

          docker stop qb

      - name: Optimize WASM
        run: |
          wasm-opt -O3 --asyncify qemu-wasm/htdocs/qemu-system-x86_64.wasm -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Create index.html
        run: |
          mkdir -p dist
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Android-x86 9.0-r2 • QEMU/WASM</title>
          <style>body{margin:0;padding:20px;background:#000;color:#0f0;font-family:system-ui;text-align:center}
          canvas{border:4px solid #0f0;border-radius:16px;max-width:100%} button{font-size:18px;padding:18px;padding:14px 32px;margin:20px;background:#000;color:#0f0;border:2px solid #0f0;border-radius:12px;cursor:pointer}</style>
          <script src="./qemu-system-x86_64.js"></script><script src="./load.js"></script>
          </head><body><h1>Android-x86 9.0-r2</h1><p>Running in browser via QEMU + WebAssembly</p>
          <canvas id="canvas" width="1024" height="768"></canvas><br>
          <button id="b">Start Android</button><p>First boot 30–90s • Chrome/Edge recommended</p>
          <script>
          const Module={canvas:document.getElementById('canvas')};
          document.getElementById('b').onclick=()=>{this.disabled=true;this.textContent="Starting…";
            const a=['-cpu','qemu64,+ssse3,+sse4.2,+popcnt','-m','2048','-smp','4',
                     '-drive','if=none,id=d0,file=/android-x86.iso,format=raw,readonly=on',
                     '-device','virtio-scsi-pci','-device','scsi-hd,drive=d0','-boot','d',
                     '-device','virtio-gpu-pci','-device','virtio-keyboard-pci','-device','virtio-mouse-pci',
                     '-nic','user,model=virtio-net-pci','-no-reboot'];
            createQemuModule(Module).then(m=>m.callMain(a));
          };
          </script></body></html>
          EOF

      - name: Assemble dist
        run: |
          cp -r qemu-wasm/htdocs/* dist/
          cp dist/index.html dist/  # overwrite

      - name: Verify
        run: |
          du -sh dist
          ls -lh dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-wasm
          path: dist/
