name: Android-x86 QEMU WebAssembly Emulator

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:
    inputs:
      download_iso:
        description: 'Download the real Android-x86 ISO (true/false)'
        required: false
        default: 'false'
      use_test_iso:
        description: 'If download fails, use a 1 MiB dummy image (true/false)'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOWNLOAD_ISO: ${{ inputs.download_iso || 'false' }}
      USE_TEST_ISO: ${{ inputs.use_test_iso || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 --recursive https://github.com/ktock/qemu-wasm.git

      - name: Build QEMU-WASM Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 ISO (robust)
        run: |
          set -euo pipefail
          mkdir -p qemu-wasm/htdocs/images
          cd qemu-wasm/htdocs/images

          URL="https://osdn.net/dl/android-x86/android-x86_64-4.4-r5.iso"
          ISO="android-x86.iso"

          if [ "${{ env.DOWNLOAD_ISO }}" = "false" ]; then
            if compgen -G "../../*android*.iso" > /dev/null; then
              cp ../../*android*.iso "$ISO"
              echo "Copied existing ISO from repository root"
              exit 0
            elif [ -f "./$ISO" ]; then
              echo "ISO already present"
              exit 0
            else
              echo "DOWNLOAD_ISO=false and no local ISO → skipping download"
              exit 0
            fi
          fi

          echo "Downloading Android-x86 ISO…"
          wget --user-agent="GitHub-Actions" --tries=10 --timeout=60 -O "$ISO" "$URL" || \
            curl -L --fail --retry 10 -o "$ISO" "$URL"

          if [ ! -f "$ISO" ] && [ "${{ env.USE_TEST_ISO }}" = "true" ]; then
            echo "Creating dummy 1 MiB image"
            dd if=/dev/zero of="$ISO" bs=1M count=1
          fi

          echo "ISO size: $(du -h "$ISO" | cut -f1)"
          sha256sum "$ISO" || true

      - name: Build qemu-system-x86_64.wasm inside Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/qemu-wasm:/src \
            -w /src \
            qemu-wasm-builder bash -c "
              set -euo pipefail
              emconfigure ./configure \
                --target-list=x86_64-softmmu \
                --disable-system \
                --disable-werror \
                --disable-capstone \
                --disable-docs
              emmake make -j\$(nproc) qemu-system-x86_64

              # Package ISO into .data file + generate loader
              python3 /emsdk/upstream/emscripten/tools/file_packager.py \
                htdocs/qemu.data \
                --preload images/android-x86.iso@/ \
                --js-output=htdocs/load.js \
                --use-preload-plugins
            "

      - name: Optimize WASM
        run: |
          command -v wasm-opt >/dev/null || sudo apt-get install -y binaryen
          for f in qemu-wasm/htdocs/*.wasm; do
            [ -f "$f" ] && wasm-opt -O3 --strip-debug "$f" -o "$f.opt" && mv "$f.opt" "$f"
          done

      - name: Create demo page (fixed syntax)
        run: |
          mkdir -p dist
          cat > dist/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Android-x86 × QEMU WebAssembly</title>
            <style>
              body { font-family: sans-serif; text-align: center; background:#111; color:#fff; }
              canvas { border: 2px solid #444; margin-top: 20px; }
            </style>
            <script src="./load.js"></script>
          </head>
          <body>
            <h1>Android-x86 running in QEMU/WASM</h1>
            <div id="screen"><canvas></canvas></div>
            <p><button id="start">Start Android</button> <button id="stop" disabled>Stop</button></p>
            <p>First boot takes ~60–90 seconds – be patient!</p>

            <script>
              document.getElementById('start').onclick = () => {
                Module({
                  canvas: document.querySelector('canvas'),
                  arguments: [
                    '-cpu', 'qemu64',
                    '-m', '1024',
                    '-smp', '2',
                    '-drive', 'file=/android-x86.iso,format=raw,readonly',
                    '-device', 'virtio-gpu-pci',
                    '-device', 'virtio-keyboard-pci',
                    '-device', 'virtio-mouse-pci',
                    '-boot', 'd'
                  ]
                });
                document.getElementById('start').disabled = true;
                document.getElementById('stop').disabled = false;
              };

              document.getElementById('stop').onclick = () => {
                if (typeof Module.stop === 'function') Module.stop();
                document.getElementById('start').disabled = false;
                document.getElementById('stop').disabled = true;
              };
            </script>
          </body>
          </html>
          EOF

      - name: Package final artifacts
        run: |
          cp -r qemu-wasm/htdocs/* dist/
          echo "Final dist contents:"
          ls -R dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-qemu-wasm
          path: dist/
