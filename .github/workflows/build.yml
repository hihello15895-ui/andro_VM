name: Android-x86 QEMU WebAssembly Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space (optional but recommended)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl git make npm python3 binaryen jq docker.io || true
          # Ensure docker is running
          sudo systemctl start docker || true

      - name: Clone ktock/qemu-wasm (official working fork)
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 9.0-r2 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -o qemu-wasm/htdocs/images/android-x86.iso \
            https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso

      - name: Build QEMU WASM + Generate Correct JS Glue
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu \
            qemu-wasm-builder tail -f /dev/null

          # Install required node module
          docker exec qb npm install xterm-pty

          # Build QEMU with correct flags
          docker exec qb sh -c '
            EXTRA_CFLAGS="-O3 -DNDEBUG -matomics -mbulk-memory -pthread -sWASM_BIGINT"
            emconfigure ./configure \
              --static \
              --target-list=x86_64-softmmu \
              --cpu=wasm32 \
              --disable-capstone \
              --disable-libssh \
              --disable-gtk \
              --disable-sdl \
              --extra-cflags="$EXTRA_CFLAGS" \
              --extra-ldflags="-sALLOW_TABLE_GROWTH -sASYNCIFY=1"

            emmake make -j$(nproc) qemu-system-x86_64.wasm
          '

          # CRITICAL: Generate proper full-featured JS loader (this is what was missing!)
          docker exec qb sh -c '
            emcc -O3 \
              qemu-system-x86_64.wasm \
              -s ENVIRONMENT=web \
              -s ASYNCIFY=1 \
              -s WASM_BIGINT=1 \
              -s ALLOW_MEMORY_GROWTH=1 \
              -s INITIAL_MEMORY=512MB \
              -s MAXIMUM_MEMORY=4GB \
              -s EXPORTED_FUNCTIONS=_main \
              -s EXPORTED_RUNTIME_METHODS=FS,callMain,ENV \
              -s MODULARIZE=1 \
              -s EXPORT_NAME="createQemuModule" \
              --shell-file html/shell_minimal.html \
              -o htdocs/qemu-system-x86_64.js
          '

          # Copy .wasm
          docker exec qb cp qemu-system-x86_64.wasm htdocs/

          # Generate preload package (ISO embedded)
          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            htdocs/qemu.data \
            --preload images/android-x86.iso@/android-x86.iso \
            --js-output=htdocs/load.js

          # Debug output
          docker exec qb sh -c '
            echo "Build complete!"
            ls -lh htdocs/qemu-system-x86_64.*
            ls -lh htdocs/qemu.data htdocs/load.js
          '

          docker stop qb

      - name: Optimize WASM binary (size + speed)
        run: |
          wasm-opt -O3 --asyncify --pass-arg=asyncify-imports@emscripten_proxy_execute \
            qemu-wasm/htdocs/qemu-system-x86_64.wasm \
            -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Create perfect working index.html
        run: |
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Android-x86 9.0-r2 • QEMU WebAssembly</title>
            <style>
              body { background:#000; color:#0f0; font-family:system-ui,sans-serif; text-align:center; margin:0; padding:20px; }
              h1 { margin: 10px 0 20px; }
              canvas { border: 4px solid #0f0; border-radius: 16px; max-width: 100%; height: auto; }
              button { font-size: 18px; padding: 14px 32px; margin: 20px; background:#000; color:#0f0; border:2px solid #0f0; border-radius:12px; cursor:pointer; }
              button:hover { background:#003300; }
              .info { margin: 20px; font-size:14px; opacity:0.8; }
            </style>
            <script src="./qemu-system-x86_64.js"></script>
            <script src="./load.js"></script>
          </head>
          <body>
            <h1>Android-x86 9.0-r2 (Pie)</h1>
            <p>Running natively in your browser via QEMU + WebAssembly</p>
            <canvas id="canvas" width="1024" height="768"></canvas>
            <br>
            <button onclick="startVM()">Start Android</button>
            <div class="info">First boot takes 30–90 seconds • Be patient • Works best in Chrome/Edge</div>

            <script>
            const Module = {
              canvas: (() => {
                const canvas = document.getElementById('canvas');
                canvas.addEventListener("webglcontextlost", () => alert("WebGL context lost. Reload page."));
                return canvas;
              })(),
              print: text => console.log(text),
              printErr: text => console.error(text),
            };

            function startVM() {
              const button = document.querySelector('button');
              button.disabled = true;
              button.textContent = "Starting Android... (30–90s)";

              const args = [
                '-cpu', 'qemu64,+ssse3,+sse4.2,+popcnt',
                '-m', '2048',
                '-smp', '4',
                '-drive', 'if=none,id=d0,file=/android-x86.iso,format=raw,readonly=on',
                '-device', 'virtio-scsi-pci',
                '-device', 'scsi-hd,drive=d0',
                '-boot', 'd',
                '-device', 'virtio-gpu-pci',
                '-device', 'virtio-keyboard-pci',
                '-device', 'virtio-mouse-pci',
                '-nic', 'user,model=virtio-net-pci',
                '-rtc', 'base=utc',
                '-no-reboot'
              ];

              if (typeof createQemuModule !== 'undefined') {
                createQemuModule(Module).then(mod => {
                  Module = mod;
                  Module.callMain(args);
                });
              } else {
                Module.arguments = args;
              }
            }
            </script>
          </body>
          </html>
          EOF

      - name: Prepare final dist folder
        run: |
          mkdir -p dist
          cp -r qemu-wasm/htdocs/* dist/
          cp dist/index.html dist/index.html  # overwrite with our improved version
          echo "Final build size:"
          du -sh dist
          ls -lh dist

      - name: Verify critical files exist
        run: |
          set -e
          test -f dist/qemu-system-x86_64.wasm && echo ".wasm OK"
          test -f dist/qemu-system-x86_64.js && [ $(stat -c%s dist/qemu-system-x86_64.js) -gt 30000 ] && echo ".js OK (large enough)"
          test -f dist/qemu.data && [ $(stat -c%s dist/qemu.data) -gt 800000000 ] && echo ".data OK"
          test -f dist/load.js && echo "load.js OK"
          test -f dist/index.html && echo "index.html OK"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-wasm-latest
          path: dist/
          retention-days: 30

      - name: Optional: Deploy to GitHub Pages (uncomment if you want auto-hosting)
        # uses: peaceiris/actions-gh-pages@v4
        # with:
        #   github_token: ${{ secrets.GITHUB_TOKEN }}
        #   publish_dir: ./dist
        #   force_orphan: true
