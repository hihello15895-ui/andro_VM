# .github/workflows/android-qemu-wasm.yml
name: Android-x86 QEMU WebAssembly (FINAL â€“ WORKS 100%)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl jq binaryen python3 ca-certificates gnupg lsb-release git make npm

      - name: Install Docker
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          sudo systemctl start docker

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1 roms/seabios roms/ipxe roms/openbios || true

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 9.0-r2 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          ASSET_URL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/hihello15895-ui/andro_VM/releases/tags/iso" \
            | jq -r '.assets[] | select(.name | endswith(".iso")) | .browser_download_url' | head -n1)

          if [ -n "$ASSET_URL" ] && [ "$ASSET_URL" != "null" ]; then
            echo "Downloading ISO from GitHub release..."
            curl -L -# -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/octet-stream" \
                 "$ASSET_URL" \
                 -o qemu-wasm/htdocs/images/android-x86.iso
          else
            echo "Downloading ISO from OSDN mirror..."
            curl -L -# -o qemu-wasm/htdocs/images/android-x86.iso \
              https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso
          fi
          
          ls -lh qemu-wasm/htdocs/images/

      - name: Build QEMU WebAssembly (inside container)
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu \
            qemu-wasm-builder tail -f /dev/null
          
          # Install xterm-pty
          docker exec qb npm install xterm-pty
          
          # Build QEMU with Emscripten
          docker exec qb sh -c '
            EXTRA_CFLAGS="-O3 -g -Wno-error=unused-command-line-argument -matomics -mbulk-memory -DNDEBUG -DG_DISABLE_ASSERT -D_GNU_SOURCE -sASYNCIFY=1 -pthread -sPROXY_TO_PTHREAD=1 -sFORCE_FILESYSTEM -sALLOW_TABLE_GROWTH -sTOTAL_MEMORY=2300MB -sWASM_BIGINT -sMALLOC=mimalloc --js-library=/qemu/node_modules/xterm-pty/emscripten-pty.js -sEXPORT_
