name: Android-x86 WebAssembly Emulator (v86)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:
    inputs:
      download_iso:
        description: 'Download the real Android-x86 ISO (true/false)'
        required: false
        default: 'false'
      use_test_iso:
        description: 'If download fails, create a tiny dummy ISO (true/false)'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOWNLOAD_ISO: ${{ inputs.download_iso || 'false' }}
      USE_TEST_ISO: ${{ inputs.use_test_iso || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.58

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git make binaryen wget curl ca-certificates clang build-essential python3

      - name: Clone v86
        run: |
          git clone --depth 1 https://github.com/copy/v86.git
          cd v86 && git submodule update --init --recursive

      - name: Download Android-x86 ISO (robust)
        run: |
          set -euo pipefail
          mkdir -p v86/images
          cd v86/images

          ISO_URL="https://osdn.net/dl/android-x86/android-x86_64-4.4-r5.iso"
          UA="Mozilla/5.0 (compatible; GitHub-Actions)"

          if [ "$DOWNLOAD_ISO" = "false" ]; then
            if ls ../../*android*.iso >/dev/null 2>&1 || [ -f android-x86.iso ]; then
              cp ../../*android*.iso android-x86.iso 2>/dev/null || true
              exit 0
            else
              echo "No ISO and download disabled -> skipping"
              exit 0
            fi
          fi

          echo "Downloading Android-x86 ISO..."
          wget --user-agent="$UA" -t 8 --timeout=30 -c -O android-x86.iso "$ISO_URL" || \
            curl -A "$UA" -L --retry 8 --fail -o android-x86.iso "$ISO_URL"

          if [ ! -f android-x86.iso ] || [ $(stat -c%s android-x86.iso) -lt 10000000 ]; then
            if [ "$USE_TEST_ISO" = "true" ]; then
              dd if=/dev/zero of=android-x86.iso bs=1M count=10
            else
              exit 1
            fi
          fi

      - name: Build v86
        run: |
          set -euo pipefail
          cd v86

          for target in build/libv86.js build/v86_all.js build/v86.wasm build/libv86.mjs libv86.js all; do
            echo "Trying make $target ..."
            emmake make -j$(nproc) "$target" && break
          done

          emmake make -j$(nproc) || npm run build || true

          if ! ls {build/,}*.js {build/,}*.wasm 2>/dev/null | grep -q .; then
            echo "No artifacts produced"
            exit 1
          fi

      - name: Package & optimize
        run: |
          mkdir -p dist
          cp v86/{build/,}*.js v86/{build/,}*.mjs v86/{build/,}*.wasm dist/ 2>/dev/null || true
          cp v86/images/android-x86.iso dist/ 2>/dev/null || true

          for f in dist/*.wasm; do
            [ -f "$f" ] && wasm-opt -O3 --strip-debug "$f" -o "$f.opt" && mv "$f.opt" "$f"
          done

      - name: Create demo page
        run: |
          cd dist

          # Using printf + literal block to avoid YAML parsing issues with < and >
          printf %s "$(cat <<'HTML'"
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Android-x86 in Browser (v86)</title>
  <style>
    body{margin:0;background:#111;color:#fff;font-family:sans-serif;text-align:center;padding:20px}
    #phone{width:400px;height:760px;margin:20px auto;border:20px solid #222;border-radius:45px;overflow:hidden;background:#000;box-shadow:0 20px 60px #0008}
    canvas{width:100%;height:100%;display:block}
    button{margin:10px;padding:15px 30px;font-size:18px;background:#0066ff;color:white;border:none;border-radius:12px;cursor:pointer}
    button:disabled{background:#444;cursor:not-allowed}
  </style>
</head>
<body>
  <h1>Android-x86 WebAssembly Emulator</h1>
  <div id="phone"><div id="screen"><canvas></canvas></div></div>
  <button id="start">Start Android</button>
  <button id="stop" disabled>Stop</button>
  <p>Boot takes 1–2 minutes. Be patient!</p>

  <script type="module">
    import * as lib from "./libv86.mjs";
    const V86 = lib.V86 || lib.default || window.V86;

    const emu = new V86({
      screen_container: document.getElementById("screen"),
      wasm_url: "./v86.wasm",
      memory_size: 512 * 1024 * 1024,
      vga_memory_size: 8 * 1024 * 1024,
      autostart: false,
      cdrom: { url: "./android-x86.iso" }
    });

    await new Promise(r => emu.add_listener("emulator-ready", r));

    document.getElementById("start").onclick = () => {
      emu.run();
      document.getElementById("start").disabled = true;
      document.getElementById("stop").disabled = false;
    };
    document.getElementById("stop").onclick = () => {
      emu.stop();
      document.getElementById("start").disabled = false;
      document.getElementById("stop").disabled = true;
    };
  </script>
</body>
</html>
HTML
          )" > index.html

          # Fallback for non-ESM builds
          if [ ! -f libv86.mjs ] && [ -f libv86.js ]; then
            cat > index.html <<'HTML'
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Android-x86 in Browser (v86)</title>
  <style>
    body{margin:0;background:#111;color:#fff;font-family:sans-serif;text-align:center;padding:20px}
    #phone{width:400px;height:760px;margin:20px auto;border:20px solid #222;border-radius:45px;overflow:hidden;background:#000;box-shadow:0 20px 60px #0008}
    canvas{width:100%;height:100%;display:block}
    button{margin:10px;padding:15px 30px;font-size:18px;background:#0066ff;color:white;border:none;border-radius:12px;cursor:pointer}
    button:disabled{background:#444;cursor:not-allowed}
  </style>
</head>
<body>
  <h1>Android-x86 WebAssembly Emulator</h1>
  <div id="phone"><div id="screen"><canvas></canvas></div></div>
  <button id="start">Start Android</button>
  <button id="stop" disabled>Stop</button>
  <p>Boot takes 1–2 minutes. Be patient!</p>

  <script src="libv86.js"></script>
  <script>
    const emu = new V86({
      screen_container: document.getElementById("screen"),
      wasm_url: "v86.wasm",
      memory_size: 512 * 1024 * 1024,
      vga_memory_size: 8 * 1024 * 1024,
      autostart: false,
      cdrom: { url: "android-x86.iso" }
    });

    emu.add_listener("emulator-ready", () => {
      document.getElementById("start").onclick = () => {
        emu.run();
        document.getElementById("start").disabled = true;
        document.getElementById("stop").disabled = false;
      };
      document.getElementById("stop").onclick = () => {
        emu.stop();
        document.getElementById("start").disabled = false;
        document.getElementById("stop").disabled = true;
      };
    });
  </script>
</body>
</html>
HTML
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-web-emulator
          path: dist/
          retention-days: 30
