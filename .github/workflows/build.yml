name: Android-x86 QEMU WebAssembly Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true

      - name: Install dependencies (Docker fixed)
        run: |
          sudo apt update
          sudo apt install -y ca-certificates curl gnupg lsb-release git make npm python3 python3-pip binaryen jq

          # Official Docker install
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          sudo chmod a+r /etc/apt/keyrings/docker.gpg

          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
            https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

          sudo apt update
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin

          # Test
          sudo docker run --rm hello-world

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm && git submodule update --init --depth 1

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 ISO from your GitHub release
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -o qemu-wasm/htdocs/images/android-x86.iso \
            https://github.com/hihello15895-ui/andro_VM/releases/download/iso/android-x86_64-9.0-r2.iso
          echo "ISO size: $(du -h qemu-wasm/htdocs/images/android-x86.iso | cut -f1)"

      - name: Build QEMU with Meson + create html dir and shell file
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu qemu-wasm-builder tail -f /dev/null

          # Install node deps
          docker exec qb npm install xterm-pty

          # CREATE html/ DIRECTORY FIRST (fixes the missing dir error)
          docker exec qb mkdir -p html

          # Now create the shell_minimal.html (minimal template for clean JS output)
          docker exec qb sh -c 'cat > html/shell_minimal.html << "EOF"
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>QEMU WASM</title>
          </head>
          <body>
            <canvas id="canvas"></canvas>
            {{{ SCRIPT }}}
          </body>
          </html>
          EOF'

          # Verify shell file created
          docker exec qb ls -la html/shell_minimal.html

          # Build with Meson (2025 method, optimized flags)
          docker exec qb sh -c '
            cat > emscripten-cross.ini << "EOF"
            [binaries]
            c = "/emsdk/upstream/emscripten/emcc"
            cpp = "/emsdk/upstream/emscripten/em++"
            ar = "/emsdk/upstream/emscripten/emar"
            strip = "/emsdk/upstream/emscripten/emstrip"
            pkgconfig = "/usr/bin/pkg-config"

            [host_machine]
            system = "emscripten"
            cpu_family = "wasm32"
            cpu = "wasm32"
            endian = "little"
            EOF

            mkdir -p build && cd build

            emconfigure meson setup .. \
              --cross-file ../emscripten-cross.ini \
              --buildtype release \
              -Dstatic=true \
              -Dtarget_list=x86_64-softmmu \
              -Dcapstone=disabled \
              -Dslirp=disabled \
              -Dvnc=disabled \
              -Dsdl=disabled \
              -Dgtk=disabled \
              -Dcocoa=disabled \
              -Ddefault_devices=false \
              -Dvirtio=enabled \
              -Dvirtio_gpu=enabled

            emmake ninja -C . -v qemu-system-x86_64
          '

          # Copy WASM binary
          docker exec qb cp build/qemu-system-x86_64.wasm htdocs/

          # Generate full JS glue (now with --shell-file, since dir/file exists)
          docker exec qb sh -c '
            cd htdocs
            emcc -O3 \
              ../build/qemu-system-x86_64.wasm \
              -s ENVIRONMENT=web \
              -s ASYNCIFY=1 \
              -s WASM_BIGINT=1 \
              -s ALLOW_MEMORY_GROWTH=1 \
              -s INITIAL_MEMORY=512MB \
              -s MAXIMUM_MEMORY=4GB \
              -s EXPORTED_FUNCTIONS=_main \
              -s EXPORTED_RUNTIME_METHODS=FS,callMain,ENV,PROXYFS \
              -s MODULARIZE=1 \
              -s EXPORT_NAME="createQemuModule" \
              --shell-file ../html/shell_minimal.html \
              -o qemu-system-x86_64.js
          '

          # Preload ISO into .data
          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            htdocs/qemu.data \
            --preload images/android-x86.iso@/android-x86.iso \
            --js-output=htdocs/load.js

          # Debug sizes
          docker exec qb sh -c '
            echo "=== htdocs files ==="
            ls -lh htdocs/
            echo "JS size: $(stat -c%s htdocs/qemu-system-x86_64.js 2>/dev/null || echo "MISSING") bytes"
          '

          docker stop qb

      - name: Optimize WASM
        run: |
          wasm-opt -O3 --asyncify \
            --pass-arg=asyncify-imports@emscripten_proxy_execute \
            qemu-wasm/htdocs/qemu-system-x86_64.wasm \
            -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Create working index.html + assemble dist
        run: |
          mkdir -p dist
          cp -r qemu-wasm/htdocs/* dist/

          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Android-x86 9.0-r2 • QEMU WebAssembly</title>
            <style>
              body { margin: 0; padding: 20px; background: #000; color: #0f0; font-family: system-ui, sans-serif; text-align: center; }
              h1 { margin: 10px 0 20px; }
              canvas { border: 4px solid #0f0; border-radius: 16px; max-width: 100%; height: auto; image-rendering: pixelated; }
              button { font-size: 18px; padding: 14px 32px; margin: 20px; background: #000; color: #0f0; border: 2px solid #0f0; border-radius: 12px; cursor: pointer; }
              button:hover { background: #003300; }
              button:disabled { opacity: 0.6; cursor: not-allowed; }
              .info { margin: 20px; font-size: 14px; opacity: 0.8; }
            </style>
            <script src="./qemu-system-x86_64.js"></script>
            <script src="./load.js"></script>
          </head>
          <body>
            <h1>Android-x86 9.0-r2 (Pie)</h1>
            <p>Running natively in your browser via QEMU + WebAssembly</p>
            <canvas id="canvas" width="1024" height="768"></canvas>
            <br>
            <button id="startBtn">Start Android</button>
            <div class="info">First boot: 40–90 seconds • Works best in Chrome/Edge/Firefox • No installation required</div>

            <script>
              let Module;
              const canvas = document.getElementById('canvas');
              canvas.addEventListener('webglcontextlost', () => alert('WebGL context lost. Please reload the page.'));

              const startBtn = document.getElementById('startBtn');
              startBtn.onclick = function() {
                this.disabled = true;
                this.textContent = 'Starting Android... (40–90s)';
                const args = [
                  '-cpu', 'qemu64,+ssse3,+sse4.2,+popcnt',
                  '-m', '2048',
                  '-smp', '4',
                  '-drive', 'if=none,id=d0,file=/android-x86.iso,format=raw,readonly=on',
                  '-device', 'virtio-scsi-pci',
                  '-device', 'scsi-hd,drive=d0',
                  '-boot', 'd',
                  '-device', 'virtio-gpu-pci',
                  '-device', 'virtio-keyboard-pci',
                  '-device', 'virtio-mouse-pci',
                  '-nic', 'user,model=virtio-net-pci',
                  '-rtc', 'base=utc',
                  '-no-reboot'
                ];
                if (typeof createQemuModule === 'function') {
                  createQemuModule({ canvas, print: console.log.bind(console), printErr: console.error.bind(console) })
                    .then(mod => {
                      Module = mod;
                      if (typeof mod.callMain === 'function') {
                        mod.callMain(args);
                      } else {
                        mod(arguments = args);
                      }
                    })
                    .catch(err => {
                      console.error('Failed to start VM:', err);
                      startBtn.disabled = false;
                      startBtn.textContent = 'Start Android';
                    });
                }
              };
            </script>
          </body>
          </html>
          EOF

      - name: Verify build
        run: |
          set -e
          du -sh dist/
          ls -lh dist/
          [ -f dist/qemu-system-x86_64.wasm ] && echo "✅ WASM built"
          JS_SIZE=$(stat -c%s dist/qemu-system-x86_64.js 2>/dev/null || echo 0)
          [ $JS_SIZE -gt 50000 ] && echo "✅ JS glue ($JS_SIZE bytes)"
          [ $(stat -c%s dist/qemu.data) -gt 900000000 ] && echo "✅ Data with ISO"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-wasm-complete
          path: dist/
          retention-days: 30
