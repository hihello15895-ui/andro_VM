name: Android-x86 QEMU WebAssembly Emulator
on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:
    inputs:
      download_iso:
        description: 'Whether to download the Android-x86 ISO (true/false)'
        required: false
        default: 'false'
      use_test_iso:
        description: 'If download fails, use a small test image instead (true/false)'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOWNLOAD_ISO: ${{ github.event.inputs.download_iso }}
      USE_TEST_ISO: ${{ github.event.inputs.use_test_iso }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker (for QEMU build)
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo service docker start
          sudo usermod -aG docker $USER
          # Wait for group to apply
          newgrp docker

      - name: Clone qemu-wasm
        run: |
          git clone --depth 1 --recursive https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm

      - name: Build QEMU WASM Docker image
        run: |
          cd qemu-wasm
          docker build -t buildqemu - < Dockerfile

      - name: Download Android-x86 ISO (robust)
        run: |
          set -eo pipefail
          DOWNLOAD_ISO="${DOWNLOAD_ISO:-false}"
          USE_TEST_ISO="${USE_TEST_ISO:-false}"
          mkdir -p qemu-wasm/htdocs/images
          cd qemu-wasm/htdocs/images
          URL="https://osdn.net/dl/android-x86/android-x86_64-4.4-r5.iso"
          UA="Mozilla/5.0 (compatible; GitHub-Action; +https://github.com)"
          echo "Downloading Android-x86 ISO from: $URL"
          if [ "${DOWNLOAD_ISO}" = "false" ]; then
            if [ -f ../../android-x86.iso ]; then
              cp ../../android-x86.iso ./android-x86.iso
            elif [ -f ../../android-x86_64-4.4-r5.iso ]; then
              cp ../../android-x86_64-4.4-r5.iso ./android-x86.iso
            elif ls ../../*android*.iso >/dev/null 2>&1; then
              SRC_ISO=$(ls ../../*android*.iso | head -n1)
              cp "$SRC_ISO" ./android-x86.iso
            elif [ -f ../../dist/android-x86.iso ]; then
              cp ../../dist/android-x86.iso ./android-x86.iso
            elif [ -f ./android-x86.iso ]; then
              echo "android-x86.iso already present; skipping download"
            else
              echo "DOWNLOAD_ISO=false and no existing ISO found; skipping download step"
              exit 0
            fi
          fi
          if command -v wget >/dev/null 2>&1; then
            wget --user-agent="$UA" --continue --tries=8 --retry-connrefused --waitretry=5 --timeout=30 --show-progress -O android-x86.iso "$URL" || WGET_EXIT=$? || true
          else
            WGET_EXIT=1
          fi
          if [ "${WGET_EXIT:-0}" != "0" ]; then
            echo "wget failed, trying curl..."
            curl -A "$UA" -L --retry 8 --retry-delay 5 --max-time 120 --fail -o android-x86.iso "$URL"
          fi
          if [ ! -f android-x86.iso ]; then
            echo "ISO download failed: file not found"
            if [ "${USE_TEST_ISO:-false}" = "true" ]; then
              echo "USE_TEST_ISO=true; creating small test image"
              dd if=/dev/zero of=android-x86.iso bs=1024 count=1024
            else
              exit 1
            fi
          fi
          echo "Downloaded file size: $(stat -c%s android-x86.iso) bytes"
          if command -v sha256sum >/dev/null 2>&1; then
            echo "SHA256: $(sha256sum android-x86.iso | awk '{print $1}')"
          fi

      - name: Build QEMU x86_64 WASM (in Docker)
        run: |
          cd qemu-wasm
          # Run container, build qemu-system-x86_64 with browser flags
          docker run --rm -v $(pwd):/work -w /work buildqemu bash -c "
            emconfigure ./configure --target-list=x86_64-softmmu --disable-system --disable-slirp --disable-virtfs --disable-vhost-net --disable-vhost-vsock --disable-vhost-user --disable-vhost-crypto --disable-vhost-vdpa --disable-docs --disable-tools --disable-guest-agent --disable-fdt --disable-libiscsi --disable-vte --disable-vnc-sasl --disable-gnutls --disable-gcrypt --disable-nettle --disable-curl --disable-spice --disable-vnc --disable-sdl --disable-gtk --disable-vte --disable-opengl --disable-virglrenderer --disable-cocoa --disable-hvf --disable-xen --disable-brlapi --disable-fdt --disable-libxml2 --disable-zstd --disable-bzip2 --disable-lzo --disable-snappy --disable-libssh --disable-qom-cast-debug --disable-capstone --disable-cap-ng --disable-attr --disable-xkbcommon --disable-alsa --disable-oss --disable-pa --disable-sndio --disable-jack --disable-pulseaudio --disable-bluez --disable-virglrenderer --disable-vhost-kernel --disable-vhost-user --disable-vhost-net --disable-vhost-vdpa --disable-vhost-vsock --disable-vhost-crypto --disable-tpm --disable-pvrdma --disable-xen --disable-hax --disable-hvf --disable-whpx --disable-kvm --disable-werror
            emmake make -j$(nproc) qemu-system-x86_64
            # Package for browser (adjust paths as needed)
            python3 /emsdk/upstream/emscripten/tools/file_packager.py htdocs/qemu.data --preload images/android-x86.iso --js-output=htdocs/load.js --no-heap-copy
          "

      - name: Optimize WASM files
        run: |
          cd qemu-wasm/htdocs
          if command -v wasm-opt >/dev/null 2>&1; then
            for f in *.wasm; do [ -f "$f" ] && wasm-opt -O4 --strip "$f" -o "$f.opt" && mv "$f.opt" "$f"; done
          fi
          echo "WASM files: $(ls *.wasm 2>/dev/null || echo 'None')"
          echo "JS files: $(ls *.js 2>/dev/null || echo 'None')"

      - name: Package everything to dist
        run: |
          mkdir -p dist
          cp -r qemu-wasm/htdocs/* dist/ 2>/dev/null || true
          echo 'dist contents:' && ls -la dist || true

      - name: Create demo page (QEMU loader)
        run: |
          mkdir -p dist
          # Base64-encoded HTML with QEMU loader (adapt from ktock examples; loads WASM and boots ISO via cmdline)
          echo 'PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICA8bWV0YSBjaGFyc2V0PSJ1dGYtOCI+CiAgPHRpdGxlPkFuZHJvaWQtWHg4NiBRRU1VIEdsb2JhbCBFbXVsYXRvcjwvdGl0bGU+CiAgPHNjcmlwdCBzcmM9Ii4vbG9hZC5qcyI+PC9zY3JpcHQ+CjwvaGVhZD4KPGJvZHk+CiAgPGgxPkFuZHJvaWQtWHg4NiBRRU1VIEdsb2JhbCBFbXVsYXRvcjwvaDE+CiAgPGRpdiBpZD0ic2NyZWVuIj48Y2FudmFzPjwvY2FudmFzPjwvZGl2PgogIDxidXR0b24gaWQ9InN0YXJ0Ij5TdGFydCBBbmRyb2lkPC9idXR0b24+CiAgPGJ1dHRvbiBpZD0ic3RvcCIgZGlzYWJsZWQ+U3RvcDwvYnV0dG9uPgogIDxwPkJvb3QgdGFrZXMgMS0yIG1pbnV0ZXMuIEJlIHBhdGllbnQhPC9wPgogIDxzY3JpcHQ+CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhcnQnKS5vbmNsaWNrID0gKCkgPT4gewogICAgICBtb2R1bGUuZGVmYXVsdCh7CiAgICAgICAgY2FudmFzOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NyZWVuJyksCiAgICAgICAgY21kX2xpbmU6ICctY2RkIHJvb3QgL21lZGlhL2Nkcm9tIC1ib290IC1tIDEyOCAtc3RhcnQgL2FuZHJvaWQtWC5pc28gLW4gL2FuZHJvaWQtWC5pc28gLWQgL2FuZHJvaWQtWC5pc28gLWQgL3N5cy9pZ25pdC5yYyAtYXBwZW5kICJjb25zb2xlPWFydCZjb25zb2xlX3NjcmVlbj0yNCx4IiAtYXV0by1hYm9ydA==  # QEMU cmdline for Android-x86 boot (base64 encoded for JS)
ICAgICAgfSk7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGFydCcpLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0b3AnKS5kaXNhYmxlZCA9IGZhbHNlOwogICAgfTsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdG9wJykub25jbGljayA9ICgpID0+IHsKICAgICAgbW9kdWxlLnN0b3AoKTsKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXJ0JykuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0b3AnKS5kaXNhYmxlZCA9IHRydWU7CiAgICB9OwogIDwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4K' | base64 --decode > dist/index.html

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: android-qemu-wasm-emulator
          path: dist/
