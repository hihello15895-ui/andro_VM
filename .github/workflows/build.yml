name: Android-x86 QEMU WebAssembly Build — FINAL WORKING

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker (official way)
        run: |
          sudo apt update
          sudo apt install -y ca-certificates curl gnupg lsb-release
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt update
          sudo apt install -y docker-ce docker-ce-cli containerd.io

      - name: Clone ktock/qemu-wasm
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm && git submodule update --init --depth 1

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download your Android-x86 ISO
        run: |
          mkdir -p qemu-wasm/htdocs/images
          curl -L -o qemu-wasm/htdocs/images/android-x86.iso \
            https://github.com/hihello15895-ui/andro_VM/releases/download/iso/android-x86_64-9.0-r2.iso

      - name: Build QEMU → REAL .wasm output (2025 fix)
        run: |
          docker run --rm -d --name qb \
            -v ${{ github.workspace }}/qemu-wasm:/qemu \
            -w /qemu qemu-wasm-builder tail -f /dev/null

          docker exec qb npm install xterm-pty

          # Create html dir + minimal shell
          docker exec qb mkdir -p html
          docker exec qb sh -c 'cat > html/shell_minimal.html << "EOF"
          <!doctype html><html><head><meta charset="utf-8"></head><body><canvas id="canvas"></canvas>{{{ SCRIPT }}}</body></html>
          EOF'

          # Cross file
          docker exec qb sh -c '
            cat > emscripten-cross.ini << "EOF"
            [binaries]
            c = "/emsdk/upstream/emscripten/emcc"
            cpp = "/emsdk/upstream/emscripten/em++"
            ar = "/emsdk/upstream/emscripten/emar"
            strip = "/emsdk/upstream/emscripten/emstrip"

            [host_machine]
            system = "emscripten"
            cpu_family = "wasm32"
            cpu = "wasm32"
            endian = "little"
            EOF
          '

          # Configure + BUILD DIRECTLY TO .wasm (this is the key line)
          docker exec qb sh -c '
            mkdir -p build && cd build

            emconfigure meson setup .. \
              --cross-file ../emscripten-cross.ini \
              --buildtype release \
              -Dstatic=true \
              -Dtarget_list=x86_64-softmmu \
              -Dcapstone=disabled -Dslirp=disabled -Dvnc=disabled \
              -Dsdl=disabled -Dgtk=disabled -Dcocoa=disabled

            # THIS LINE IS CRITICAL — forces .wasm output
            emmake ninja qemu-system-x86_64.wasm
          '

          # Now we have the real .wasm file
          docker exec qb cp build/qemu-system-x86_64.wasm htdocs/

          # Generate proper JS glue
          docker exec qb sh -c '
            cd htdocs
            emcc -O3 qemu-system-x86_64.wasm \
              -s ENVIRONMENT=web \
              -s ASYNCIFY=1 \
              -s WASM_BIGINT=1 \
              -s ALLOW_MEMORY_GROWTH=1 \
              -s INITIAL_MEMORY=512MB \
              -s MAXIMUM_MEMORY=4GB \
              -s MODULARIZE=1 \
              -s EXPORT_NAME="createQemuModule" \
              -s EXPORTED_FUNCTIONS=_main \
              -s EXPORTED_RUNTIME_METHODS=FS,callMain \
              --shell-file ../html/shell_minimal.html \
              -o qemu-system-x86_64.js
          '

          # Package ISO
          docker exec qb python3 /emsdk/upstream/emscripten/tools/file_packager.py \
            htdocs/qemu.data --preload images/android-x86.iso@/android-x86.iso \
            --js-output=htdocs/load.js

         

          docker stop qb

      - name: Optimize WASM
        run: |
          wasm-opt -O3 --asyncify qemu-wasm/htdocs/qemu-system-x86_64.wasm -o qemu-wasm/htdocs/qemu-system-x86_64.wasm

      - name: Create final index.html
        run: |
          mkdir -p dist
          cp -r qemu-wasm/htdocs/* dist/
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Android-x86 9.0-r2</title>
          <style>body{margin:0;background:#000;color:#0f0;font-family:system-ui;text-align:center;padding:20px}
          canvas{border:4px solid #0f0;border-radius:16px;max-width:100%;image-rendering:pixelated}</style>
          <script src="qemu-system-x86_64.js"></script><script src="load.js"></script>
          </head><body><h1>Android-x86 9.0-r2 • WebAssembly</h1>
          <canvas id="canvas" width="1024" height="768"></canvas><br>
          <button onclick="this.disabled=1;this.textContent='Starting…';createQemuModule({canvas:document.getElementById('canvas')}).then(m=>m.callMain(['-cpu','qemu64,+ssse3,+sse4.2,+popcnt','-m','2048','-smp','4','-drive','if=none,id=d0,file=/android-x86.iso,format=raw,readonly=on','-device','virtio-scsi-pci','-device','scsi-hd,drive=d0','-boot','d','-device','virtio-gpu-pci','-device','virtio-keyboard-pci','-device','virtio-mouse-pci','-no-reboot']))">Start Android</button>
          <p>First boot 40–90s • Chrome/Edge recommended</p></body></html>
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-wasm-working
          path: dist/
