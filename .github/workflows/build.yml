# .github/workflows/android-qemu-wasm.yml
name: Android-x86 QEMU WebAssembly (ISO from Release – No repo upload needed)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Docker (official)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ca-certificates curl gnupg lsb-release
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          sudo systemctl start docker

      - name: Clone ktock/qemu-wasm (2025 working version)
        run: |
          git clone --depth 1 https://github.com/ktock/qemu-wasm.git
          cd qemu-wasm
          git submodule update --init --depth 1 roms/seabios roms/ipxe

      - name: Build Docker image
        working-directory: qemu-wasm
        run: docker build -t qemu-wasm-builder .

      - name: Download Android-x86 9.0-r2 ISO from your GitHub Release
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: "hihello15895-ui/andro_VM"
          version: "tags/iso"
          file: "android-x86_64-9.0-r2.iso"
          target: "qemu-wasm/htdocs/images/android-x86.iso"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fallback: Direct download if release fetch fails
        if: failure()
        run: |
          mkdir -p qemu-wasm/htdocs/images
          cd qemu-wasm/htdocs/images
          echo "Downloading Android-x86 9.0-r2 from official mirror (~750 MB)..."
          curl -L -# -o android-x86.iso \
            https://osdn.net/dl/android-x86/android-x86_64-9.0-r2.iso
          echo "Download complete: $(du -h android-x86.iso)"

      - name: Build QEMU → WebAssembly + bundle ISO
        run: |
          docker run --rm -v ${{ github.workspace }}/qemu-wasm:/src -w /src qemu-wasm-builder bash -c "
            set -euo pipefail
            emconfigure ./configure \
              --target-list=x86_64-softmmu \
              --disable-werror --disable-capstone --disable-docs --disable-system \
              --extra-cflags='-s USE_PTHREADS=1 -s PTHREAD_POOL_SIZE=4' \
              --extra-ldflags='-s USE_PTHREADS=1 -s PTHREAD_POOL_SIZE=4 -s TOTAL_MEMORY=1GB -s ALLOW_MEMORY_GROWTH=1'

            emmake make -j$(nproc) qemu-system-x86_64

            python3 /emsdk/upstream/emscripten/tools/file_packager.py \
              htdocs/qemu.data \
              --preload images/android-x86.iso@/android-x86.iso \
              --js-output=htdocs/load.js \
              --use-preload-plugins \
              --lz4
          "

      - name: Optimize WASM
        run: |
          sudo apt-get install -y binaryen
          for f in qemu-wasm/htdocs/*.wasm; do
            [ -f "$f" ] && wasm-opt -O3 --fast-math "$f" -o "$f.opt" && mv "$f.opt" "$f"
          done

      - name: Create final index.html
        run: |
          mkdir -p dist
          cat > dist/index.html <<'EOF'
          <!DOCTYPE html><html><head><meta charset=utf-8><title>Android
