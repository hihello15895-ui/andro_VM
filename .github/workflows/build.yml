name: Android-x86 WebAssembly Emulator (v86)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.58

      - name: Install tools
        run: sudo apt-get update -y && sudo apt-get install -y git make binaryen wget curl ca-certificates

      - name: Clone v86
        run: |
          git clone --depth 1 https://github.com/copy/v86.git
          cd v86 && git submodule update --init --recursive

      - name: Download Android-x86 ISO (robust)
        run: |
          set -euo pipefail
          mkdir -p v86/images
          cd v86/images
          URL="https://osdn.net/dl/android-x86/android-x86_64-4.4-r5.iso"
          # Set a user agent to avoid being blocked by some servers
          UA="Mozilla/5.0 (compatible; GitHub-Action; +https://github.com)"
          echo "Downloading Android-x86 ISO from: $URL"
          # Prefer wget if available, but use fallback to curl. Keep verbose logs for diagnostics
            if command -v wget >/dev/null 2>&1; then
            wget --user-agent="$UA" --continue --tries=8 --retry-connrefused --waitretry=5 --timeout=30 --show-progress -O android-x86.iso "$URL" || WGET_EXIT=$? || true
          else
            echo "wget not found, trying curl..."
            WGET_EXIT=1
          fi
          if [ "${WGET_EXIT:-0}" != "0" ]; then
            echo "wget failed (exit=${WGET_EXIT:-0}), trying curl as fallback..."
            # curl --fail causes non-zero exit on HTTP 4xx/5xx
              if command -v curl >/dev/null 2>&1; then
              curl -A "$UA" -L --retry 8 --retry-delay 5 --max-time 120 --fail -o android-x86.iso "$URL"
            else
              echo "curl not available" >&2
              exit 1
            fi
          fi
          # Verify we've got a reasonably-sized file and show diagnostics
          if [ ! -f android-x86.iso ]; then
            echo "ISO download failed: file not found" >&2
            exit 1
          fi
          echo "Downloaded file size:" $(stat -c%s android-x86.iso) "bytes"
          # Optional: print first bytes only (hexdump) and compute sha256 for traceability
          if command -v sha256sum >/dev/null 2>&1; then
            echo "SHA256: $(sha256sum android-x86.iso | awk '{print $1}')"
          fi

      - name: Build v86
        run: |
          cd v86
          emmake make -j$(nproc) libv86.js

      # This is the ONLY safe way to do WASM optimization in GitHub Actions
      - name: Optimize WASM files
        run: |
          cd v86
          bash -c 'for f in *.wasm; do [ -f "$f" ] && wasm-opt -O4 --strip "$f" -o "$f.opt" && mv "$f.opt" "$f" || true; done'

      - name: Package everything
        run: |
          mkdir -p dist
          cp v86/libv86.js dist/
          cp v86/*.wasm dist/ 2>/dev/null || true
          cp v86/images/android-x86.iso dist/

      - name: Create demo page
        run: |
          mkdir -p dist
            echo 'PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICA8bWV0YSBjaGFyc2V0PSJ1dGYtOCI+CiAgPHRpdGxlPkFuZHJvaWQteDg2IGluIEJyb3dzZXI8L3RpdGxlPgo8L2hlYWQ+Cjxib2R5PgogIDxoMT5BbmRyb2lkLXg4NiBXZWJBc3NlbWJseSBFbXVsYXRvcjwvaDE+CiAgPGRpdiBpZD0ic2NyZWVuIj48Y2FudmFzPjwvY2FudmFzPjwvZGl2PgogIDxidXR0b24gaWQ9InN0YXJ0Ij5TdGFydCBBbmRyb2lkPC9idXR0b24+CiAgPGJ1dHRvbiBpZD0ic3RvcCIgZGlzYWJsZWQ+U3RvcDwvYnV0dG9uPgogIDxwPkJvb3QgdGFrZXMgMeKAkzIgbWludXRlcy4gQmUgcGF0aWVudCE8L3A+CiAgPHNjcmlwdCB0eXBlPSJtb2R1bGUiPgogICAgaW1wb3J0IHtWODZ9IGZyb20gJy4vbGlidjg2LmpzJzsKICAgIGNvbnN0IGVtdSA9IG5ldyBWODYoewogICAgICBzY3JlZW5fY29udGFpbmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NyZWVuJyksCiAgICAgIHdhc21fdXJsOiAnLi92ODYud2FzbScsCiAgICAgIG1lbW9yeV9zaXplOiA1MTIqMTAyNCoxMDI0LAogICAgICB2Z2FfbWVtb3J5X3NpemU6IDgqMTAyNCoxMDI0LAogICAgICBhdXRvc3RhcnQ6IGZhbHNlCiAgICB9KTsKICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gZW11LmFkZF9saXN0ZW5lcignZW11bGF0b3ItcmVhZHknLCByKSk7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhcnQnKS5vbmNsaWNrID0gKCkgPT4geyBlbXUucnVuKCk7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGFydCcpLmRpc2FibGVkID0gdHJ1ZTsgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0b3AnKS5kaXNhYmxlZCA9IGZhbHNlOyB9OwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0b3AnKS5vbmNsaWNrID0gKCkgPT4geyBlbXUuc3RvcCgpOyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhcnQnKS5kaXNhYmxlZCA9IGZhbHNlOyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RvcCcpLmRpc2FibGVkID0gdHJ1ZTsKICAgPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg==' | base64 --decode > dist/index.html

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: android-x86-web-emulator
          path: dist/
